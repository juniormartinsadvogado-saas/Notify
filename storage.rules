
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // --- FUNÇÕES AUXILIARES ---

    function isAuthenticated() {
      return request.auth != null;
    }

    // --- REGRAS ---

    // 1. FOTO DE PERFIL
    match /fotos_perfil/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // 2. DOCUMENTOS ASSINADOS (PDFs)
    // Permite leitura pública (allow read: if true) para que destinatários não logados
    // possam baixar o PDF clicando no link do e-mail.
    // A segurança é feita pela obscuridade do token/URL longa gerada.
    match /notificacoes/{notificationId}/documento_assinado.pdf {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // 3. EVIDÊNCIAS E OUTROS ARQUIVOS DA NOTIFICAÇÃO
    // Mantém restrito, pois apenas o dono ou o sistema precisa acessar
    match /notificacoes/{notificationId}/{allPaths=**} {
      allow write: if isAuthenticated();
      allow read: if isAuthenticated();
    }
    
    // 4. ARQUIVOS PESSOAIS (File Manager)
    match /user_files/{userId}/{allPaths=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
  }
}
